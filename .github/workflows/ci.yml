name: Continuous Integration

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  lint:
    name: Lint
    runs-on: macos-latest
    timeout-minutes: 90
    steps:
      - name: Set GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.VERSION_BUMPER_APPID }}
          private-key: ${{ secrets.VERSION_BUMPER_SECRET }}

      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # pulls all history and tags for Lerna to detect which packages changed
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Repo
        uses: ./.github/actions/setup
        env:
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}
          REACT_APP_APPLE_APP_ID: ${{ secrets.REACT_APP_APPLE_APP_ID }}
          REACT_APP_DROPBOX_CLIENT_KEY: ${{ secrets.REACT_APP_DROPBOX_CLIENT_KEY }}
          REACT_APP_DROPBOX_CLIENT_SECRET: ${{ secrets.REACT_APP_DROPBOX_CLIENT_SECRET }}
          REACT_APP_GOOGLE_MAPS_IOS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_IOS_API_KEY }}
          REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY }}
          REACT_APP_GOOGLE_PACKAGE_NAME: ${{ secrets.REACT_APP_GOOGLE_PACKAGE_NAME }}
          REACT_APP_IAPHUB_API_KEY: ${{ secrets.REACT_APP_IAPHUB_API_KEY }}
          REACT_APP_IAPHUB_APP_ID: ${{ secrets.REACT_APP_IAPHUB_APP_ID }}
          REACT_APP_ICLOUD_API_TOKEN: ${{ secrets.REACT_APP_ICLOUD_API_TOKEN }}
          REACT_APP_ICLOUD_CONTAINER: ${{ secrets.REACT_APP_ICLOUD_CONTAINER }}
          REACT_APP_MAPBOX_TOKEN: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          YARN_NODE_LINKER: node-modules

      - name: Check Formatting
        run: |
          yarn format:check
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}

      - name: Check Linting
        run: |
          yarn lint:check
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}


  typecheck:
    name: Type Check
    runs-on: macos-latest
    timeout-minutes: 90
    steps:
      - name: Set GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.VERSION_BUMPER_APPID }}
          private-key: ${{ secrets.VERSION_BUMPER_SECRET }}

      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # pulls all history and tags for Lerna to detect which packages changed
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Repo
        uses: ./.github/actions/setup
        env:
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}
          REACT_APP_APPLE_APP_ID: ${{ secrets.REACT_APP_APPLE_APP_ID }}
          REACT_APP_DROPBOX_CLIENT_KEY: ${{ secrets.REACT_APP_DROPBOX_CLIENT_KEY }}
          REACT_APP_DROPBOX_CLIENT_SECRET: ${{ secrets.REACT_APP_DROPBOX_CLIENT_SECRET }}
          REACT_APP_GOOGLE_MAPS_IOS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_IOS_API_KEY }}
          REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY }}
          REACT_APP_GOOGLE_PACKAGE_NAME: ${{ secrets.REACT_APP_GOOGLE_PACKAGE_NAME }}
          REACT_APP_IAPHUB_API_KEY: ${{ secrets.REACT_APP_IAPHUB_API_KEY }}
          REACT_APP_IAPHUB_APP_ID: ${{ secrets.REACT_APP_IAPHUB_APP_ID }}
          REACT_APP_ICLOUD_API_TOKEN: ${{ secrets.REACT_APP_ICLOUD_API_TOKEN }}
          REACT_APP_ICLOUD_CONTAINER: ${{ secrets.REACT_APP_ICLOUD_CONTAINER }}
          REACT_APP_MAPBOX_TOKEN: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          YARN_NODE_LINKER: node-modules

      - name: Check Types
        run: |
          yarn build:check-types
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}

      - name: Check Circular Dependencies
        run: |
          yarn build:check-circular
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}

  test:
    name: Unit Tests
    runs-on: macos-latest
    timeout-minutes: 90
    steps:
      - name: Set GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.VERSION_BUMPER_APPID }}
          private-key: ${{ secrets.VERSION_BUMPER_SECRET }}

      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # pulls all history and tags for Lerna to detect which packages changed
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Repo
        uses: ./.github/actions/setup
        env:
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}
          REACT_APP_APPLE_APP_ID: ${{ secrets.REACT_APP_APPLE_APP_ID }}
          REACT_APP_DROPBOX_CLIENT_KEY: ${{ secrets.REACT_APP_DROPBOX_CLIENT_KEY }}
          REACT_APP_DROPBOX_CLIENT_SECRET: ${{ secrets.REACT_APP_DROPBOX_CLIENT_SECRET }}
          REACT_APP_GOOGLE_MAPS_IOS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_IOS_API_KEY }}
          REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY }}
          REACT_APP_GOOGLE_PACKAGE_NAME: ${{ secrets.REACT_APP_GOOGLE_PACKAGE_NAME }}
          REACT_APP_IAPHUB_API_KEY: ${{ secrets.REACT_APP_IAPHUB_API_KEY }}
          REACT_APP_IAPHUB_APP_ID: ${{ secrets.REACT_APP_IAPHUB_APP_ID }}
          REACT_APP_ICLOUD_API_TOKEN: ${{ secrets.REACT_APP_ICLOUD_API_TOKEN }}
          REACT_APP_ICLOUD_CONTAINER: ${{ secrets.REACT_APP_ICLOUD_CONTAINER }}
          REACT_APP_MAPBOX_TOKEN: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          YARN_NODE_LINKER: node-modules

      - name: Check Unit Tests
        run: |
          yarn unit:ci
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}

  build-android:
    name: Build Android
    runs-on: macos-latest
    timeout-minutes: 90
    steps:
      - name: Set GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.VERSION_BUMPER_APPID }}
          private-key: ${{ secrets.VERSION_BUMPER_SECRET }}

      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # pulls all history and tags for Lerna to detect which packages changed
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Repo
        uses: ./.github/actions/setup
        env:
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}
          REACT_APP_APPLE_APP_ID: ${{ secrets.REACT_APP_APPLE_APP_ID }}
          REACT_APP_DROPBOX_CLIENT_KEY: ${{ secrets.REACT_APP_DROPBOX_CLIENT_KEY }}
          REACT_APP_DROPBOX_CLIENT_SECRET: ${{ secrets.REACT_APP_DROPBOX_CLIENT_SECRET }}
          REACT_APP_GOOGLE_MAPS_IOS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_IOS_API_KEY }}
          REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY }}
          REACT_APP_GOOGLE_PACKAGE_NAME: ${{ secrets.REACT_APP_GOOGLE_PACKAGE_NAME }}
          REACT_APP_IAPHUB_API_KEY: ${{ secrets.REACT_APP_IAPHUB_API_KEY }}
          REACT_APP_IAPHUB_APP_ID: ${{ secrets.REACT_APP_IAPHUB_APP_ID }}
          REACT_APP_ICLOUD_API_TOKEN: ${{ secrets.REACT_APP_ICLOUD_API_TOKEN }}
          REACT_APP_ICLOUD_CONTAINER: ${{ secrets.REACT_APP_ICLOUD_CONTAINER }}
          REACT_APP_MAPBOX_TOKEN: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          YARN_NODE_LINKER: node-modules

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Download Geocoder Database from GitHub Pre-Release (Android)
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'tags/pre-release-database'
          file: 'BBBGeocoder.realm'
          target: './android/app/src/main/assets/BBBGeocoder.realm'
          token: ${{ secrets.GH_PAT }}
  
      - name: (Android) Create Android Keystore File
        run: |
          echo "${{ secrets.ANDROID_SIGNING_KEY }}" | base64 --decode > ${{ github.workspace }}/android/bbbook-key.keystore

      - name: (Android) Verify keystore file
        run: |
          if [ -f ${{ github.workspace }}/android/bbbook-key.keystore ]; then
            echo "Keystore file exists."
          else
            echo "Keystore file does not exist."
            exit 1
          fi

      - name: Create local.properties
        run: |
          echo "ANDROID_ALIAS=${{ secrets.ANDROID_ALIAS }}" >> ${{ github.workspace }}/android/local.properties
          echo "ANDROID_KEY_STORE_PASSWORD=${{ secrets.ANDROID_KEY_STORE_PASSWORD }}" >> ${{ github.workspace }}/android/local.properties
          echo "ANDROID_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> ${{ github.workspace }}/android/local.properties
  
      - name: Print local.properties
        run: cat ${{ github.workspace }}/android/local.properties

      - name: Build Android App for Maestro Cloud
        run: yarn android:build:ci:apk:release
        env:
          ORG_GRADLE_PROJECT_reactNativeArchitectures: x86_64
          METRO_DISABLE_CACHE: 1
          REACT_APP_APPLE_APP_ID: ${{ secrets.REACT_APP_APPLE_APP_ID }}
          REACT_APP_DROPBOX_CLIENT_KEY: ${{ secrets.REACT_APP_DROPBOX_CLIENT_KEY }}
          REACT_APP_DROPBOX_CLIENT_SECRET: ${{ secrets.REACT_APP_DROPBOX_CLIENT_SECRET }}
          REACT_APP_GOOGLE_MAPS_IOS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_IOS_API_KEY }}
          REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY }}
          REACT_APP_GOOGLE_PACKAGE_NAME: ${{ secrets.REACT_APP_GOOGLE_PACKAGE_NAME }}
          REACT_APP_IAPHUB_API_KEY: ${{ secrets.REACT_APP_IAPHUB_API_KEY }}
          REACT_APP_IAPHUB_APP_ID: ${{ secrets.REACT_APP_IAPHUB_APP_ID }}
          REACT_APP_ICLOUD_API_TOKEN: ${{ secrets.REACT_APP_ICLOUD_API_TOKEN }}
          REACT_APP_ICLOUD_CONTAINER: ${{ secrets.REACT_APP_ICLOUD_CONTAINER }}
          REACT_APP_MAPBOX_TOKEN: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}
       
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: ./android/app/build/outputs/apk/release/app-release.apk

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    timeout-minutes: 90
    steps:
      - name: Set GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.VERSION_BUMPER_APPID }}
          private-key: ${{ secrets.VERSION_BUMPER_SECRET }}

      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # pulls all history and tags for Lerna to detect which packages changed
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Repo
        uses: ./.github/actions/setup
        env:
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}
          REACT_APP_APPLE_APP_ID: ${{ secrets.REACT_APP_APPLE_APP_ID }}
          REACT_APP_DROPBOX_CLIENT_KEY: ${{ secrets.REACT_APP_DROPBOX_CLIENT_KEY }}
          REACT_APP_DROPBOX_CLIENT_SECRET: ${{ secrets.REACT_APP_DROPBOX_CLIENT_SECRET }}
          REACT_APP_GOOGLE_MAPS_IOS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_IOS_API_KEY }}
          REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY }}
          REACT_APP_GOOGLE_PACKAGE_NAME: ${{ secrets.REACT_APP_GOOGLE_PACKAGE_NAME }}
          REACT_APP_IAPHUB_API_KEY: ${{ secrets.REACT_APP_IAPHUB_API_KEY }}
          REACT_APP_IAPHUB_APP_ID: ${{ secrets.REACT_APP_IAPHUB_APP_ID }}
          REACT_APP_ICLOUD_API_TOKEN: ${{ secrets.REACT_APP_ICLOUD_API_TOKEN }}
          REACT_APP_ICLOUD_CONTAINER: ${{ secrets.REACT_APP_ICLOUD_CONTAINER }}
          REACT_APP_MAPBOX_TOKEN: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          YARN_NODE_LINKER: node-modules

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}

      - name: (iOS) Set NODE_BINARY environment variable
        working-directory: ./ios
        run: |
          ln -s $(command -v node) /usr/local/bin/node
          export NODE_BINARY=$(command -v node)
          export NO_FLIPPER=1
          echo export NODE_BINARY=$(command -v node) > .xcode.env
          echo export NODE_BINARY=$(command -v node) > .xcode.env.local
          echo export NO_FLIPPER=1 >> .xcode.env.local

      - name: (iOS) Select Xcode Version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0.1'

      - name: (iOS) Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.0'
          bundler-cache: true # Automatically install gems and cache them

      - name: Install ccache
        run: brew install ccache

      - name: (iOS) Pod Install
        run: |
          yarn ios:podinstall
        env:
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}

      - name: (iOS) Print .xcode.env file content
        working-directory: ./ios
        run: cat .xcode.env

      - name: Install Bundler
        working-directory: ./ios
        run: gem install bundler
      
      - name: (iOS) Install dependencies
        working-directory: ./ios
        run: |
          echo ">>> INSTALL DEPENDENCIES"
          bundle install

      - name: (iOS) Create .netrc file for MapBox
        run: |
          touch ~/.netrc
          chmod 600 ~/.netrc
          echo "machine api.mapbox.com" >>~/.netrc
          echo "login mapbox" >>~/.netrc
          echo "password ${{ secrets.REACT_APP_MAPBOX_TOKEN }}" >>~/.netrc
          echo "machine github.com" >>~/.netrc
          echo "login worldlee78" >>~/.netrc
          echo "password ${{ secrets.GITHUB_TOKEN }}" >>~/.netrc

      - name: Download Geocoder Database from GitHub Pre-Release (iOS)
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'tags/pre-release-database'
          file: 'BBBGeocoder.realm'
          target: './ios/Resources/BBBGeocoder.realm'
          token: ${{ secrets.GH_PAT }}
         
      - name: Import code sign
        uses: Apple-Actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATES_FILE_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}

      - name: Download provisioning
        uses: Apple-Actions/download-provisioning-profiles@v1
        with:
          bundle-id: com.gtek-solutions.biggerblackerbook
          profile-type: 'IOS_APP_STORE'
          issuer-id: ${{ secrets.APPLE_APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPLE_APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.APPLE_APPSTORE_PRIVATE_KEY }}

      - name: Build iOS App
        run: yarn ios:ci:build
        env:
          REACT_APP_APPLE_APP_ID: ${{ secrets.REACT_APP_APPLE_APP_ID }}
          REACT_APP_DROPBOX_CLIENT_KEY: ${{ secrets.REACT_APP_DROPBOX_CLIENT_KEY }}
          REACT_APP_DROPBOX_CLIENT_SECRET: ${{ secrets.REACT_APP_DROPBOX_CLIENT_SECRET }}
          REACT_APP_GOOGLE_MAPS_IOS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_IOS_API_KEY }}
          REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY }}
          REACT_APP_GOOGLE_PACKAGE_NAME: ${{ secrets.REACT_APP_GOOGLE_PACKAGE_NAME }}
          REACT_APP_IAPHUB_API_KEY: ${{ secrets.REACT_APP_IAPHUB_API_KEY }}
          REACT_APP_IAPHUB_APP_ID: ${{ secrets.REACT_APP_IAPHUB_APP_ID }}
          REACT_APP_ICLOUD_API_TOKEN: ${{ secrets.REACT_APP_ICLOUD_API_TOKEN }}
          REACT_APP_ICLOUD_CONTAINER: ${{ secrets.REACT_APP_ICLOUD_CONTAINER }}
          REACT_APP_MAPBOX_TOKEN: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}

  e2e-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 90
    needs: [build-android]
    steps:
      - name: Set GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.VERSION_BUMPER_APPID }}
          private-key: ${{ secrets.VERSION_BUMPER_SECRET }}

      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # pulls all history and tags for Lerna to detect which packages changed
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Repo
        uses: ./.github/actions/setup
        env:
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}
          REACT_APP_APPLE_APP_ID: ${{ secrets.REACT_APP_APPLE_APP_ID }}
          REACT_APP_DROPBOX_CLIENT_KEY: ${{ secrets.REACT_APP_DROPBOX_CLIENT_KEY }}
          REACT_APP_DROPBOX_CLIENT_SECRET: ${{ secrets.REACT_APP_DROPBOX_CLIENT_SECRET }}
          REACT_APP_GOOGLE_MAPS_IOS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_IOS_API_KEY }}
          REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY }}
          REACT_APP_GOOGLE_PACKAGE_NAME: ${{ secrets.REACT_APP_GOOGLE_PACKAGE_NAME }}
          REACT_APP_IAPHUB_API_KEY: ${{ secrets.REACT_APP_IAPHUB_API_KEY }}
          REACT_APP_IAPHUB_APP_ID: ${{ secrets.REACT_APP_IAPHUB_APP_ID }}
          REACT_APP_ICLOUD_API_TOKEN: ${{ secrets.REACT_APP_ICLOUD_API_TOKEN }}
          REACT_APP_ICLOUD_CONTAINER: ${{ secrets.REACT_APP_ICLOUD_CONTAINER }}
          REACT_APP_MAPBOX_TOKEN: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          YARN_NODE_LINKER: node-modules

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: app-release-apk
          path: ./android/app/build/outputs/apk/release/

      - name: Run End to End Tests
        uses: mobile-dev-inc/action-maestro-cloud@v1
        with:
            api-key: ${{ secrets.MAESTRO_API_KEY }}
            project-id: ${{ secrets.MAESTRO_PROJECT_ID }}
            app-file: ./android/app/build/outputs/apk/release/app-release.apk
            workspace: maestro/
            android-api-level: 34
            env: |
              MAESTRO_APP_ID=com.gteksolutions.BiggerBlackerBook
