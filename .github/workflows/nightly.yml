name: Nightly Regression Tests

on:
  schedule:
    - cron: "0 2 * * *" # runs daily at 2â€¯AM UTC
  workflow_dispatch:

jobs:
  nightly-regression:
    runs-on: macos-latest
    timeout-minutes: 150
    env:
        REACT_APP_APPLE_APP_ID: ${{ secrets.REACT_APP_APPLE_APP_ID }}
        REACT_APP_DROPBOX_CLIENT_KEY: ${{ secrets.REACT_APP_DROPBOX_CLIENT_KEY }}
        REACT_APP_DROPBOX_CLIENT_SECRET: ${{ secrets.REACT_APP_DROPBOX_CLIENT_SECRET }}
        REACT_APP_GOOGLE_MAPS_IOS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_IOS_API_KEY }}
        REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
        REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY }}
        REACT_APP_GOOGLE_PACKAGE_NAME: ${{ secrets.REACT_APP_GOOGLE_PACKAGE_NAME }}
        REACT_APP_IAPHUB_API_KEY: ${{ secrets.REACT_APP_IAPHUB_API_KEY }}
        REACT_APP_IAPHUB_APP_ID: ${{ secrets.REACT_APP_IAPHUB_APP_ID }}
        REACT_APP_ICLOUD_API_TOKEN: ${{ secrets.REACT_APP_ICLOUD_API_TOKEN }}
        REACT_APP_ICLOUD_CONTAINER: ${{ secrets.REACT_APP_ICLOUD_CONTAINER }}
        REACT_APP_MAPBOX_TOKEN: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
        NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
        GOOGLE_PLAY_JSON_KEY: ${{ secrets.ANDROID_SERVICE_ACCOUNT_JSON_TEXT }}
        NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}

    steps:
      - name: Set GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.VERSION_BUMPER_APPID }}
          private-key: ${{ secrets.VERSION_BUMPER_SECRET }}

      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # pulls all history and tags for Lerna to detect which packages changed
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Repo
        uses: ./.github/actions/setup
        env:
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}
          REACT_APP_APPLE_APP_ID: ${{ secrets.REACT_APP_APPLE_APP_ID }}
          REACT_APP_DROPBOX_CLIENT_KEY: ${{ secrets.REACT_APP_DROPBOX_CLIENT_KEY }}
          REACT_APP_DROPBOX_CLIENT_SECRET: ${{ secrets.REACT_APP_DROPBOX_CLIENT_SECRET }}
          REACT_APP_GOOGLE_MAPS_IOS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_IOS_API_KEY }}
          REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY }}
          REACT_APP_GOOGLE_PACKAGE_NAME: ${{ secrets.REACT_APP_GOOGLE_PACKAGE_NAME }}
          REACT_APP_IAPHUB_API_KEY: ${{ secrets.REACT_APP_IAPHUB_API_KEY }}
          REACT_APP_IAPHUB_APP_ID: ${{ secrets.REACT_APP_IAPHUB_APP_ID }}
          REACT_APP_ICLOUD_API_TOKEN: ${{ secrets.REACT_APP_ICLOUD_API_TOKEN }}
          REACT_APP_ICLOUD_CONTAINER: ${{ secrets.REACT_APP_ICLOUD_CONTAINER }}
          REACT_APP_MAPBOX_TOKEN: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          YARN_NODE_LINKER: node-modules

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Download Geocoder Database from GitHub Pre-Release (Android)
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'tags/pre-release-database'
          file: 'BBBGeocoder.realm'
          target: './android/app/src/main/assets/BBBGeocoder.realm'
          token: ${{ secrets.GH_PAT }}
  
      - name: (Android) Create Android Keystore File
        run: |
          echo "${{ secrets.ANDROID_SIGNING_KEY }}" | base64 --decode > ${{ github.workspace }}/android/bbbook-key.keystore

      - name: (Android) Verify keystore file
        run: |
          if [ -f ${{ github.workspace }}/android/bbbook-key.keystore ]; then
            echo "Keystore file exists."
          else
            echo "Keystore file does not exist."
            exit 1
          fi

      - name: Create local.properties
        run: |
          echo "ANDROID_ALIAS=${{ secrets.ANDROID_ALIAS }}" >> ${{ github.workspace }}/android/local.properties
          echo "ANDROID_KEY_STORE_PASSWORD=${{ secrets.ANDROID_KEY_STORE_PASSWORD }}" >> ${{ github.workspace }}/android/local.properties
          echo "ANDROID_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> ${{ github.workspace }}/android/local.properties
  
      - name: Print local.properties
        run: cat ${{ github.workspace }}/android/local.properties

      - name: Build Android App for Maestro Cloud
        run: yarn android:build:ci:apk:release
        env:
          MAESTRO_APP_ID: com.gteksolutions.BiggerBlackerBook
          REACT_APP_APPLE_APP_ID: ${{ secrets.REACT_APP_APPLE_APP_ID }}
          REACT_APP_DROPBOX_CLIENT_KEY: ${{ secrets.REACT_APP_DROPBOX_CLIENT_KEY }}
          REACT_APP_DROPBOX_CLIENT_SECRET: ${{ secrets.REACT_APP_DROPBOX_CLIENT_SECRET }}
          REACT_APP_GOOGLE_MAPS_IOS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_IOS_API_KEY }}
          REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_ANDROID_API_KEY }}
          REACT_APP_GOOGLE_PACKAGE_NAME: ${{ secrets.REACT_APP_GOOGLE_PACKAGE_NAME }}
          REACT_APP_IAPHUB_API_KEY: ${{ secrets.REACT_APP_IAPHUB_API_KEY }}
          REACT_APP_IAPHUB_APP_ID: ${{ secrets.REACT_APP_IAPHUB_APP_ID }}
          REACT_APP_ICLOUD_API_TOKEN: ${{ secrets.REACT_APP_ICLOUD_API_TOKEN }}
          REACT_APP_ICLOUD_CONTAINER: ${{ secrets.REACT_APP_ICLOUD_CONTAINER }}
          REACT_APP_MAPBOX_TOKEN: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          NPM_TOKEN_GOOGLE_SIGN_IN: ${{ secrets.NPM_TOKEN_GOOGLE_SIGN_IN }}
          NPM_TOKEN_FONT_AWESOME: ${{ secrets.NPM_TOKEN_FONT_AWESOME }}
       
      - name: Run End to End Tests
        uses: mobile-dev-inc/action-maestro-cloud@v1
        with:
            api-key: ${{ secrets.MAESTRO_API_KEY }}
            project-id: ${{ secrets.MAESTRO_PROJECT_ID }}
            app-file: ./android/app/build/outputs/apk/release/app-release.apk
            workspace: maestro/
            android-api-level: 34
            env: |
              MAESTRO_APP_ID=com.gteksolutions.BiggerBlackerBook
     
